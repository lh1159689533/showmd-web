import { HTMLToken, FileInfo } from './types';

/**
 * 获取附件图标
 * @param fileType 附件类型
 */
const fileTypeIcon = {
  default:
    '<svg  viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M768 977.92H256c-30.72 0-66.56-15.36-87.04-35.84-25.6-25.6-35.84-56.32-35.84-87.04V168.96c0-30.72 15.36-66.56 35.84-87.04S225.28 46.08 256 46.08h343.04c10.24 0 20.48 5.12 25.6 10.24l256 256c5.12 5.12 10.24 15.36 10.24 25.6v512c0 30.72-15.36 66.56-35.84 87.04-20.48 25.6-56.32 40.96-87.04 40.96zM256 122.88c-10.24 0-25.6 5.12-30.72 15.36-10.24 10.24-15.36 20.48-15.36 30.72v680.96c0 10.24 5.12 25.6 15.36 30.72 10.24 10.24 20.48 15.36 30.72 15.36h512c10.24 0 25.6-5.12 30.72-15.36 10.24-10.24 15.36-20.48 15.36-30.72V358.4l-235.52-235.52H256z" fill="#A69364" p-id="110846"></path><path d="M855.04 378.88h-256c-20.48 0-40.96-15.36-40.96-40.96v-256c0-20.48 15.36-40.96 40.96-40.96s40.96 15.36 40.96 40.96v215.04h215.04c20.48 0 40.96 15.36 40.96 40.96s-20.48 40.96-40.96 40.96zM680.96 593.92H343.04c-20.48 0-40.96-15.36-40.96-40.96 0-20.48 15.36-40.96 40.96-40.96h343.04c20.48 0 40.96 15.36 40.96 40.96-5.12 20.48-25.6 40.96-46.08 40.96zM680.96 762.88H343.04c-20.48 0-40.96-15.36-40.96-40.96s15.36-40.96 40.96-40.96h343.04c20.48 0 40.96 15.36 40.96 40.96s-25.6 40.96-46.08 40.96zM424.96 419.84H343.04c-20.48 0-40.96-15.36-40.96-40.96s15.36-40.96 40.96-40.96h87.04c20.48 0 40.96 15.36 40.96 40.96s-25.6 40.96-46.08 40.96z" fill="#A69364"></path></svg>',
  word: '<svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M1024 298.666667V85.333333c0-25.6-17.066667-42.666667-42.666667-42.666666H298.666667c-25.6 0-42.666667 17.066667-42.666667 42.666666v213.333334l384 85.333333 384-85.333333z" fill="#41A5EE" p-id="2445"></path><path d="M1024 298.666667H256v213.333333l405.333333 85.333333 362.666667-85.333333z" fill="#2B7CD3"></path><path d="M1024 512H256v213.333333l384 64 384-64z" fill="#185ABD"></path><path d="M1024 725.333333H256v213.333334c0 25.6 17.066667 42.666667 42.666667 42.666666h682.666666c25.6 0 42.666667-17.066667 42.666667-42.666666v-213.333334z" fill="#103F91"></path><path d="M588.8 256H256v597.333333h324.266667c29.866667 0 59.733333-29.866667 59.733333-59.733333V307.2c0-29.866667-21.333333-51.2-51.2-51.2z" opacity=".5"></path><path d="M546.133333 810.666667H51.2C21.333333 810.666667 0 789.333333 0 759.466667V264.533333C0 234.666667 21.333333 213.333333 51.2 213.333333h499.2c25.6 0 46.933333 21.333333 46.933333 51.2v499.2c0 25.6-21.333333 46.933333-51.2 46.933334z" fill="#185ABD"></path><path d="M435.2 682.666667H371.2L298.666667 448 226.133333 682.666667H162.133333L93.866667 341.333333h59.733333l46.933333 238.933334 72.533334-230.4h51.2l68.266666 230.4L443.733333 341.333333h59.733334l-68.266667 341.333334z" fill="#FFFFFF"></path></svg>',
  pdf: '<svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M748.307692 0H315.076923C271.753846 0 236.307692 35.446154 236.307692 78.769231v196.923077h433.23077v39.384615h137.846153c11.815385 0 19.692308 7.876923 19.692308 19.692308v39.384615c0 11.815385-7.876923 19.692308-19.692308 19.692308H669.538462v78.769231h137.846153c11.815385 0 19.692308 7.876923 19.692308 19.692307v39.384616c0 11.815385-7.876923 19.692308-19.692308 19.692307H669.538462v78.769231h137.846153c11.815385 0 19.692308 7.876923 19.692308 19.692308v39.384615c0 11.815385-7.876923 19.692308-19.692308 19.692308H669.538462v39.384615H236.307692v196.923077c0 43.323077 35.446154 78.769231 78.769231 78.769231h590.769231c43.323077 0 78.769231-35.446154 78.769231-78.769231V236.307692l-236.307693-236.307692z" fill="#FF837D"></path><path d="M181.169231 433.230769h-15.753846v51.2h19.692307c19.692308 0 31.507692-11.815385 31.507693-27.569231-3.938462-15.753846-15.753846-23.630769-35.446154-23.630769zM342.646154 437.169231L338.707692 551.384615h3.938462c27.569231 0 51.2-11.815385 51.2-59.076923s-23.630769-55.138462-51.2-55.138461z" fill="#FF2B15"></path><path d="M630.153846 196.923077H78.769231c-19.692308 0-39.384615 19.692308-39.384616 39.384615v551.384616c0 19.692308 19.692308 39.384615 39.384616 39.384615h551.384615c19.692308 0 39.384615-19.692308 39.384616-39.384615V236.307692c0-19.692308-19.692308-39.384615-39.384616-39.384615zM185.107692 527.753846h-19.692307V590.769231H114.215385v-196.923077h70.892307c35.446154-3.938462 78.769231 15.753846 78.769231 66.953846 0 47.261538-35.446154 66.953846-78.769231 66.953846zM346.584615 590.769231H287.507692v-196.923077h59.076923c59.076923 0 102.4 27.569231 102.4 98.461538-3.938462 66.953846-43.323077 98.461538-102.4 98.461539z m263.876923-153.6h-74.830769v39.384615h66.953846v43.323077h-66.953846V590.769231h-51.2v-196.923077h129.969231v43.323077z" fill="#FF2B15"></path></svg>',
  json: '<svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M512 579.584a99.328 99.328 0 0 0-18.944 62.464 102.4 102.4 0 0 0 18.944 61.952 59.392 59.392 0 0 0 51.2 24.064 60.928 60.928 0 0 0 51.2-23.04 97.28 97.28 0 0 0 17.92-61.952 104.96 104.96 0 0 0-17.92-64 58.368 58.368 0 0 0-51.2-23.552 60.928 60.928 0 0 0-51.2 24.064z" fill="#3488F0"></path><path d="M970.24 431.104H916.48V215.552L700.416 0H215.552a107.52 107.52 0 0 0-107.52 108.032v323.072H53.76A53.76 53.76 0 0 0 0 484.864v323.584a53.76 53.76 0 0 0 53.76 53.76h54.272v53.76A108.032 108.032 0 0 0 215.552 1024h592.896a108.032 108.032 0 0 0 107.52-108.032v-53.76h53.76A53.76 53.76 0 0 0 1024 808.448V484.864a53.76 53.76 0 0 0-53.76-53.76zM161.792 102.4A53.76 53.76 0 0 1 215.552 46.592h431.104V153.6a108.032 108.032 0 0 0 108.032 108.032h108.032v162.304H161.792z m527.872 537.088a138.24 138.24 0 0 1-35.328 98.304 120.32 120.32 0 0 1-92.16 37.888 119.296 119.296 0 0 1-90.624-36.352 131.072 131.072 0 0 1-34.816-94.208 139.776 139.776 0 0 1 35.84-99.328 122.368 122.368 0 0 1 94.208-38.4 115.712 115.712 0 0 1 89.6 36.864 135.68 135.68 0 0 1 33.28 95.232z m-347.648 44.544a168.448 168.448 0 0 0-47.616-25.6q-60.928-25.6-60.928-75.264a65.536 65.536 0 0 1 27.648-56.32 121.344 121.344 0 0 1 72.704-19.968 179.2 179.2 0 0 1 64 9.728v51.2a105.984 105.984 0 0 0-60.928-17.92 62.464 62.464 0 0 0-32.768 7.68 22.528 22.528 0 0 0-12.288 19.968 25.6 25.6 0 0 0 8.192 18.432 156.672 156.672 0 0 0 41.472 23.04 135.168 135.168 0 0 1 51.2 34.816 69.12 69.12 0 0 1 14.336 44.032 66.56 66.56 0 0 1-26.624 56.832 124.928 124.928 0 0 1-73.216 20.992 161.28 161.28 0 0 1-73.216-14.336v-55.296A108.544 108.544 0 0 0 307.2 732.16a60.416 60.416 0 0 0 33.792-7.68 23.552 23.552 0 0 0 11.264-19.968 28.16 28.16 0 0 0-10.24-20.48zM97.28 775.68a97.28 97.28 0 0 1-36.352-7.68v-51.2a51.2 51.2 0 0 0 32.768 10.752q39.936 0 39.936-60.416V512h55.296v157.696a117.248 117.248 0 0 1-23.552 78.848 84.992 84.992 0 0 1-68.096 27.136z m764.928 133.12a53.76 53.76 0 0 1-53.76 53.76H215.552a53.76 53.76 0 0 1-53.76-53.76V855.04h700.416z m102.4-137.728h-57.344l-110.08-167.936a192.512 192.512 0 0 1-12.288-20.992 409.6 409.6 0 0 1 0 41.472v147.456h-51.2V512h59.904l105.984 163.328 12.8 20.48a240.128 240.128 0 0 1 0-35.84V512h51.2z" fill="#3488F0"></path></svg>',
  txt: '<svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M870.4 1024h-716.8A51.2 51.2 0 0 1 102.4 972.8v-921.6A51.2 51.2 0 0 1 153.6 0h569.685333a42.666667 42.666667 0 0 1 30.037334 12.288l155.989333 155.989333a42.666667 42.666667 0 0 1 12.288 30.037334V972.8a51.2 51.2 0 0 1-51.2 51.2zM153.6 34.133333a17.066667 17.066667 0 0 0-17.066667 17.066667v921.6a17.066667 17.066667 0 0 0 17.066667 17.066667h716.8a17.066667 17.066667 0 0 0 17.066667-17.066667V198.314667a7.168 7.168 0 0 0-2.389334-5.802667l-155.989333-155.989333a7.168 7.168 0 0 0-5.802667-2.389334z" fill="#4D4D4D"></path><path d="M904.533333 204.8h-170.666666a17.066667 17.066667 0 0 1-17.066667-17.066667v-170.666666h34.133333V170.666667h153.6z" fill="#4D4D4D"></path><path d="M204.8 170.666667h443.733333v34.133333H204.8zM204.8 307.2h614.4v34.133333H204.8zM204.8 443.733333h614.4v34.133334H204.8zM204.8 580.266667h614.4v34.133333H204.8zM204.8 853.333333h614.4v34.133334H204.8zM204.8 716.8h614.4v34.133333H204.8z" fill="#B3B3B3"></path><path d="M51.2 460.8m17.066667 0l887.466666 0q17.066667 0 17.066667 17.066667l0 273.066666q0 17.066667-17.066667 17.066667l-887.466666 0q-17.066667 0-17.066667-17.066667l0-273.066666q0-17.066667 17.066667-17.066667Z" fill="#C69C6D"></path><path d="M955.733333 477.866667v273.066666H68.266667v-273.066666h887.466666m0-34.133334H68.266667a34.133333 34.133333 0 0 0-34.133334 34.133334v273.066666a34.133333 34.133333 0 0 0 34.133334 34.133334h887.466666a34.133333 34.133333 0 0 0 34.133334-34.133334v-273.066666a34.133333 34.133333 0 0 0-34.133334-34.133334z" fill="#8C6239" p-id="29881"></path><path d="M326.997333 698.709333v-144.725333H273.066667v-23.893333h131.754666v23.893333H352.938667v144.725333zM495.274667 614.4l-55.637334-83.626667h31.402667l40.96 62.805334h2.048l41.642667-63.488h29.354666L527.701333 614.4l55.978667 83.968h-30.378667L512 636.245333h-2.048l-41.984 62.464h-28.672zM671.061333 698.709333v-144.725333h-52.906666v-23.893333H750.933333v23.893333h-53.930666v144.725333z" fill="#FFFFFF"></path></svg>',
  excel:
    '<svg viewBox="0 0 1130 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M757.927069 0.081196H339.100512a43.958646 43.958646 0 0 0-46.546198 46.516456v232.671506l465.372755 232.671507 186.15505 69.804426L1130.237169 511.940665V279.2989L757.927069 0.081196z" fill="#21A366" p-id="44608"></path><path d="M284.970109 279.2989h465.372755v232.671507H284.970109z" fill="#107C41"></path><path d="M1130.266911 46.597652v232.671506H757.956811V0.081196h325.763902a50.055752 50.055752 0 0 1 46.546198 46.516456z" fill="#33C481"></path><path d="M757.927069 512.000149H292.554314v465.372755a43.958646 43.958646 0 0 0 46.546198 46.546198h744.590459A43.958646 43.958646 0 0 0 1130.237169 977.372904v-232.671507z" fill="#185C37"></path><path d="M647.435614 232.752702h-362.852151v651.527806h353.691622a70.072104 70.072104 0 0 0 65.164677-65.164678V288.60814a53.773499 53.773499 0 0 0-56.004148-55.855438z" opacity=".5"></path><path d="M595.714312 837.764051H55.897382A53.773499 53.773499 0 0 1 0.041944 781.908614V242.091684a53.773499 53.773499 0 0 1 55.855438-55.855438h544.486421a52.821756 52.821756 0 0 1 51.185946 55.855438v544.486421a52.821756 52.821756 0 0 1-55.855437 51.185946z" fill="#107C41"></path><path d="M158.269276 698.155199l120.990373-186.15505-111.681134-186.155051h88.422906l60.495186 116.350625c9.30924 13.948988 9.30924 23.258228 13.948989 27.927718l13.948988-27.927718 65.164677-116.350625h83.753415l-111.681134 186.155051 116.350625 186.15505h-93.062654l-69.804427-130.299613c0-4.639749-4.639749-9.30924-9.309239-18.618479 0 4.639749-4.639749 9.30924-9.30924 18.618479l-69.804426 130.299613z" fill="#FFFFFF"></path><path d="M757.956811 512.000149h372.3101v232.671506H757.956811z" fill="#107C41"></path></svg>',
  html: '<svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="106119" width="16" height="16"><path d="M89.088 59.392l62.464 803.84c1.024 12.288 9.216 22.528 20.48 25.6L502.784 993.28c6.144 2.048 12.288 2.048 18.432 0l330.752-104.448c11.264-4.096 19.456-14.336 20.48-25.6l62.464-803.84c1.024-17.408-12.288-31.744-29.696-31.744H118.784c-17.408 0-31.744 14.336-29.696 31.744z" fill="#FC490B" p-id="106120"></path><path d="M774.144 309.248h-409.6l12.288 113.664h388.096l-25.6 325.632-227.328 71.68-227.328-71.68-13.312-169.984h118.784v82.944l124.928 33.792 123.904-33.792 10.24-132.096H267.264L241.664 204.8h540.672z" fill="#FFFFFF"></path></svg>',
};

/**
 * 预览节点
 * @param text markdown文本
 */
const createAttachFileTokens = (text: string): HTMLToken[] => {
  const fileInfo: FileInfo = text.split('\n')?.reduce((acc, item) => {
    const [key, val] = item?.split(':')?.map((item) => item.trim()) ?? [];
    if (key && val) acc[key] = val;
    return acc;
  }, {});

  // 下载按钮，只有文件读写模式为rw时才显示
  const downloadIcon = `
    <div class="file-icon file-download rounded-full border p-1 cursor-pointer tooltip tooltip-notext" data-tooltip="下载">
      <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11187" width="16" height="16"><path d="M896 789.333333v106.666667a42.666667 42.666667 0 0 1-42.666667 42.666667H170.666667a42.666667 42.666667 0 0 1-42.666667-42.666667v-106.666667a21.333333 21.333333 0 0 1 21.333333-21.333333h42.666667a21.333333 21.333333 0 0 1 21.333333 21.333333v64h597.333334v-64a21.333333 21.333333 0 0 1 21.333333-21.333333h42.666667a21.333333 21.333333 0 0 1 21.333333 21.333333z m-341.333333-190.485333l128.426666-128.426667a21.333333 21.333333 0 0 1 30.186667 0l30.165333 30.165334a21.333333 21.333333 0 0 1 0 30.165333l-211.2 211.2a21.269333 21.269333 0 0 1-30.144 0l-211.2-211.2a21.333333 21.333333 0 0 1 0-30.165333l30.165334-30.186667a21.333333 21.333333 0 0 1 30.186666 0L469.333333 588.501333V128a21.333333 21.333333 0 0 1 21.333334-21.333333h42.666666a21.333333 21.333333 0 0 1 21.333334 21.333333v470.848z" p-id="11188" fill="currentColor"></path></svg>
    </div>
  `;

  const content = `
    <div class="file-type-icon">
      ${fileTypeIcon[fileInfo.type] ?? fileTypeIcon.default}
    </div>
    <div class="file-content flex-1 flex items-center">
      <div class="file-name tooltip" style="max-width:16ch" data-tooltip="${fileInfo.name}"></div>
      <div class="file-size text-gray-400">（${fileInfo.size}）</div>
    </div>
    <div class="file-actions flex gap-3">
      <a style="color: #333" href="${location.protocol}//${location.hostname}:1229/${fileInfo.path}" target="_blank">
        <div class="file-icon file-preview rounded-full border p-1 cursor-pointer tooltip tooltip-notext" data-tooltip="预览">
          <svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M512 128C256 128 25.6 377.6 0 512c25.6 134.4 256 384 512 384s486.4-249.6 512-384c-25.6-134.4-256-384-512-384z m0 704c-192 0-416-211.2-448-320 32-108.8 256-320 448-320s416 211.2 448 320c-32 108.8-256 320-448 320z m0-512c-108.8 0-192 83.2-192 192s83.2 192 192 192 192-83.2 192-192-83.2-192-192-192z m0 320c-70.4 0-128-57.6-128-128s57.6-128 128-128 128 57.6 128 128-57.6 128-128 128z" p-id="4875" fill="currentColor"></path></svg>
        </div>
      </a>
      ${fileInfo.mode === 'rw' ? downloadIcon : ''}
    </div>
  `;

  return [
    {
      type: 'openTag',
      tagName: 'div',
      classNames: ['file-container flex gap-4 items-center p-2 border rounded max-w-xs'],
      outerNewLine: true,
    },
    {
      type: 'html',
      content,
    },
    { type: 'closeTag', tagName: 'div', outerNewLine: true },
  ];
};

/**
 * 附件插件
 */
const attachFilePlugin = () => {
  return {
    toHTMLRenderers: {
      file(node) {
        if (node.literal) {
          return createAttachFileTokens(node.literal);
        }
      },
    },
  };
};

export { attachFilePlugin };
